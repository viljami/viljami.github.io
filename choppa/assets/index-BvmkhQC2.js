const t={BASE_URL:"/choppa",DEV:0,MODE:"production",PROD:1,SSR:0,VITE_DEBUG:"false"};let e=1;try{const{VITE_DEBUG:s}=t;e="false"!=s}catch(Qs){e=1}const s=e,n=t=>{if(s&&(null==t||0==t))throw Error("Must missing");return t},a=t=>!t.isRemoved();class i{removed=0;isRemoved(){return this.removed}remove(){this.removed=1}}class o extends i{constructor(t,e){super(),this.id=t,this.world=e}components=new Map;add(t){t.entity=this;const e=t.constructor,s=this.tryGet(e);return s&&(s.entity=null,s.remove()),this.world._addComponentOnly(t),this.components.set(t.kind,t),this}tryGet(t){const e=this.components.get(t.name);return e?.isRemoved()?void 0:e}get(t){return n(this.tryGet(t))}has(t){const e=this.components.get(t.name);return e?!e.isRemoved():0}}class r extends i{constructor(t){super(),this.kind=t}entity=null}class c{entities=[];components=new Map;systems=[];currentId=0;reset(){this.entities.forEach((t=>{t.world=null,t.components.clear()})),this.entities.length=0,this.components.forEach((t=>t.forEach((t=>t.entity=null)))),this.components.clear(),this.systems.length=0}step(t){for(let e of this.systems)e(t,this);this.cleanup()}cleanup(){this.entities.some((t=>t.isRemoved()))&&(this.entities=this.entities.filter((t=>t.isRemoved()?(t.world=null,0):1)));for(let[t,e]of this.components.entries()){let s=0;for(let t of e)(t.isRemoved()||t.entity?.isRemoved())&&(s=1,t.remove(),t.entity?.components.delete(t.kind),t.entity=null);s&&this.components.set(t,e.filter((t=>!t.isRemoved())))}}createEntity(){const t=new o(this.createId(),this);return this.entities.push(t),t}_addComponentOnly(t){const e=this.components.get(t.kind);e?e.push(t):this.components.set(t.kind,[t])}addSystem(t){this.systems.push(t)}removeSystem(t){const e=this.systems.findIndex((e=>e===t));return e>-1?!!this.systems.splice(e,1):0}createId(){return++this.currentId}tryGet(t){const e=this.components.get(t.name);return e&&e?.length>0?e:null}get(t){return n(this.tryGet(t))}}const l=t=>t[0],{abs:h,random:u,pow:d,min:f,max:m,atan2:g,sin:y,cos:p,round:v,hypot:x,PI:w,floor:b}=Math,_=2*w,S=(t,e,s)=>f(m(t,e),s),P=(t,e,s)=>t<=e&&e<=s||t>=e&&e>=s,T=(t,e)=>u()*(e-t)+t,R=t=>k(t,w),M=t=>t[b(u()*t.length)],k=(t,e)=>((t%=2*e)>e&&(t-=2*e),t<-e&&(t+=2*e),t);class E extends Float32Array{constructor(t=0,e=0){super(2),this[0]=t,this[1]=e}get x(){return this[0]}get y(){return this[1]}set x(t){this[0]=t}set y(t){this[1]=t}abs(){return E.create(Math.abs(this[0]),Math.abs(this[1]))}absMut(){return this[0]=Math.abs(this[0]),this[1]=Math.abs(this[1]),this}clap(){return this.clone().clapMut()}clapMut(){return this[0]=~~this[0],this[1]=~~this[1],this}clone(){return E.create(this.x,this.y)}copyFrom(t){return this[0]=t[0],this[1]=t[1],this}add(t){return E.create(this.x+t.x,this.y+t.y)}addMut(t){return this.x+=t.x,this.y+=t.y,this}subtractMut(t){return this[0]-=t[0],this[1]-=t[1],this}subtract(t){return E.create(this[0]-t[0],this[1]-t[1])}normalize(){return this.divide(this.magnitude())}normalizeMut(){return this.divideMut(this.magnitude())}magnitude(){return x(this[0],this[1])}magnitudePow2(){return this[0]**2+this[1]**2}dist(t){return e=this.x,s=this.y,n=t.x,a=t.y,x(e-n,s-a);var e,s,n,a}distPow2(t){return(this.x-t.x)**2+(this.y-t.y)**2}angle(t){return g(t.y-this.y,t.x-this.x)}rotate(t){return this.clone().rotateMut(t)}rotateMut(t){const e=p(t),s=y(t);return this[0]=this[0]*e-this[1]*s,this[1]=this[0]*s+this[1]*e,this}transformMut(t,e,s,n,a,i){return this[0]=this[0]*t+this[1]*e+1*a,this[1]=this[0]*s+this[1]*n+1*i,this}divide(t){return E.create(this[0]/t,this[1]/t)}divideMut(t){return this[0]/=t,this[1]/=t,this}multiply(t){return E.create(this[0]*t,this[1]*t)}multiplyMut(t){return this[0]*=t,this[1]*=t,this}dot(t){return E.create(this[0]*t[0],this[1]*t[1])}dotMut(t){return this[0]*=t[0],this[1]*=t[1],this}limit(t,e){return this.clone().limitMut(t,e)}limitMut(t,e){return this[0]=S(t.x,this[0],e.x),this[1]=S(t.y,this[1],e.y),this}static create(t=0,e=0){return new E(t,e)}static fromAngle(t){return E.create(p(t),y(t))}}const A="touch";let C=navigator.userAgent.match(/andro|ipho|ipa|ipo/i)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1?A:"keyboard";const B=C===A,z={pos:new E,down:0};onmousedown=({x:t,y:e})=>{z.pos.x=t,z.pos.y=e,z.down=1},onmousemove=({x:t,y:e})=>{z.pos.x=t,z.pos.y=e},onmouseup=({x:t,y:e})=>{z.pos.x=t,z.pos.y=e,z.down=0},onmouseleave=onmouseenter=()=>{z.down=0};const G=[];onkeydown=({keyCode:t})=>{G[0]=G[t]=1},onkeyup=({keyCode:t})=>{G[0]=G[t]=0},onblur=onfocus;const D=[],O=[E.create(),E.create(),E.create(),E.create(),E.create(),E.create(),E.create(),E.create(),E.create(),E.create()];try{if(B){const t=t=>{C=A,D.length=0,t.preventDefault(),t.stopPropagation();for(let e=0;e<t.touches.length;e++){const s=t.touches[e];if(O[e].x=(s.pageX-I.marginLeft)*I.ratioX,O[e].y=(s.pageY-I.marginTop)*I.ratioY,D.push(O[e]),e++,e>=O.length)break}};ontouchstart=t,ontouchmove=t,ontouchend=t}}catch(Qs){}onfocus=()=>{z.down=0,G.length=0,D.length=0};const F=1600,L=900,I=new class{constructor(){this.size=E.create(F,L),this.halfSize=E.create(800,450),this.width=F,this.height=L,this.singleWidth=F,this.singleHeight=L,this.halfWidth=800,this.halfHeight=450,this.marginTop=0,this.marginLeft=0,this.ratioX=1,this.ratioY=1,this.isLandscape=1,this.isPortrait=0,this.min=E.create(),this.max=E.create(),this.resize=()=>{this.width=F,this.height=L,this.marginTop=0,this.marginLeft=0;const{innerWidth:t,innerHeight:e}=window,s=t/e,a=this.width/this.height;let i,o;const r=document.getElementById("g").style,c=this.width*this.height,l=C===A;if(l){if(t>e){const t=this.width;this.width=this.height,this.height=t}for(this.width/this.height<s?this.height=this.width/s:this.width=this.height*s;this.width*this.height/c<.5;)this.width*=2,this.height*=2;i=this.width,o=this.height,this.marginLeft=~~((window.innerWidth-i/2)/2)}else s<=a?(i=t,o=i/a,this.marginTop=~~((e-o)/2)):(o=e,i=o*a,this.marginLeft=~~(window.innerWidth-i/2)),r.marginTop=this.marginTop+"px";this.isLandscape=this.width>this.height,this.isPortrait=!this.isLandscape,l&&this.isLandscape&&(i=~~(i/2),o=~~(o/2)),this.halfWidth=this.width/2,this.halfHeight=this.height/2,this.canvas=n(this.canvas),this.canvas.width=this.width,this.canvas.height=this.height,r.width=~~i+"px",r.height=~~o+"px",this.ratioX=~~(this.width/i),this.ratioY=~~(this.height/o),this.size.x=this.width,this.size.y=this.height,this.halfSize.x=~~this.halfWidth,this.halfSize.y=~~this.halfHeight}}setSingleViewSize(t,e){this.singleWidth=t,this.singleHeight=e}setBounds(t,e){this.min=t,this.max=e}setCanvas(t){this.context=n(t.getContext("2d")),this.canvas=t}};class q{constructor(t,e){this.center=t,this.halfSize=e}clone(){return q.create(this.center.clone(),this.halfSize.clone())}transform(t,e,s,n,a,i){const o=E.create(a,i),r=E.create(a,i),c=this.minX,l=this.maxX,h=this.minY,u=this.maxY;let d=t*c,f=t*l;o.x+=d<f?d:f,r.x+=d<f?f:d,d=e*c,f=e*l,o.x+=d<f?d:f,r.x+=d<f?f:d,d=s*h,f=s*u,o.y+=d<f?d:f,r.y+=d<f?f:d,d=n*h,f=n*u,o.y+=d<f?d:f,r.y+=d<f?f:d;const m=r.subtractMut(o).divideMut(2),g=o.addMut(m);return q.create(g,m)}merge(t){let{minX:e,maxX:s,minY:n,maxY:a}=this;return e=e<t.minX?e:t.minX,s=s>t.maxX?s:t.maxX,n=n<t.minY?n:t.minY,a=a>t.maxY?a:t.maxY,this.halfSize.x=(s-e)/2,this.halfSize.y=(a-n)/2,this.center.x=e+this.halfSize.x,this.center.y=n+this.halfSize.y,this}is_overlap(t){return j(this,t)}get midX(){return this.center.x}get midY(){return this.center.y}get minX(){return this.center.x-this.halfSize.x}get maxX(){return this.center.x+this.halfSize.x}get minY(){return this.center.y-this.halfSize.y}get maxY(){return this.center.y+this.halfSize.y}static create(t,e){return new q(t,e)}}const j=(t,e)=>!(t.center.x+t.halfSize.x<e.center.x-e.halfSize.x||t.center.y+t.halfSize.y<e.center.y-e.halfSize.y||t.center.x-t.halfSize.x>e.center.x+e.halfSize.x||t.center.y-t.halfSize.y>e.center.y+e.halfSize.y);class W{constructor(){this.age=0}step(t){this.age+=t}reset(){this.age=0}}class X extends W{constructor(t){super(),this.duration=t}getProgress(){return this.age>=this.duration?1:this.age/this.duration}isDone(){return this.age>=this.duration}}const Y=t=>t,H=t=>1+2.70158*d(t-1,3)+1.70158*d(t-1,2),N=(t,e,s)=>s*(e-t)+t,U=(t,e,s,n=Y)=>N(t,e,n(S(0,s,1)));class V{constructor(t,e){this.easingFn=e,this.current=0,this.timer=new X(t)}clone(){return new V(this.timer.duration,this.easingFn)}step(t){return this.timer.step(t),this.current=this.easingFn(this.timer.getProgress()),this.current}interpolate(t,e){return N(t,e,this.current)}}class J{}class K extends J{constructor(t){super(),this.points=t,this.aabb=q.create(E.create(),E.create()),this.aabb=this.getAABB()}clone(){return K.create(this.points.map((t=>t.clone())))}getAABB(){let t=this.points[0].x,e=this.points[0].y,s=this.points[0].x,n=this.points[0].y;for(let a of this.points)t=f(t,a.x),e=f(e,a.y),s=m(s,a.x),n=m(n,a.y);return this.aabb.halfSize.x=(s-t)/2,this.aabb.halfSize.y=(n-e)/2,this.aabb.center.x=t+this.aabb.halfSize.x,this.aabb.center.y=e+this.aabb.halfSize.y,this.aabb}getType(){return 2}move(t,e=0){this.points.forEach((s=>{s.rotateMut(e),s.addMut(t)}))}yAt(t){let e=0;for(;this.points[e]&&this.points[e].x<t;)e++;const s=this.points[e-1],n=this.points[e];return s&&n?U(s.y,n.y,(t-s.x)/(n.x-s.x)):null}static create(t){return new K(t)}}class $ extends J{constructor(t,e){super(),this.center=t,this.halfSize=e,this.aabb=q.create(E.create(),E.create()),this.vertices=K.create([E.create(this.center.x-this.halfSize.x,this.center.y-this.halfSize.y),E.create(this.center.x+this.halfSize.x,this.center.y-this.halfSize.y),E.create(this.center.x+this.halfSize.x,this.center.y+this.halfSize.y),E.create(this.center.x-this.halfSize.x,this.center.y+this.halfSize.y),E.create(this.center.x-this.halfSize.x,this.center.y-this.halfSize.y)]),this.aabb=this.getAABB()}clone(){return $.create(this.center.clone(),this.halfSize.clone())}move(t,e=0){this.center.rotateMut(e),this.center.addMut(t),this.vertices.move(t,e)}getAABB(){return this.vertices.getAABB()}getType(){return 1}yAt(t){return this.aabb.minX>=t&&this.aabb.maxX<=t?this.aabb.maxY:null}static create(t,e){return new $(t,e)}}class Q extends J{constructor(t,e){super(),this.center=t,this.radius=e,this.aabb=q.create(E.create(),E.create()),this.aabb=this.getAABB()}clone(){return Q.create(this.center.clone(),this.radius)}move(t,e=0){this.center.rotateMut(e),this.center.addMut(t)}getAABB(){return this.aabb.halfSize.x=this.radius,this.aabb.halfSize.y=this.radius,this.aabb.center.x=this.center.x,this.aabb.center.y=this.center.y,this.aabb}getType(){return 0}yAt(t){return this.aabb.minX>=t&&this.aabb.maxX<=t?y(Math.acos(t/(2*this.radius)-this.radius))*this.radius:null}static create(t,e){return new Q(t,e)}}class Z{constructor(t,e){this.pos=t,this.dir=e}}const tt=(t,e)=>{let s=0;for(;e.points[s]&&e.points[s].x<t.center.x;)s++;const n=e.points[s-1],a=e.points[s];if(!n||!a)return 0;const i=n.dist(a),o=R(n.angle(a)),r=R(R(n.angle(t.center))-o),c=n.dist(t.center),l=p(r)*c/i;if(h(y(r)*c)>t.radius)return 0;if(!P(0,l,1)&&c>t.radius&&a.dist(t.center)>t.radius)return 0;const u=n.x+l*(a.x-n.x),d=n.y+l*(a.y-n.y);return new Z(E.create(u,d),E.create(p(o+w/2),y(o+w/2)))},et=(t,e)=>tt(t,e.vertices),st=(t,e)=>{switch(t.getType()){case 0:switch(e.getType()){case 0:return((t,e)=>{const s=e.center.subtract(t.center),n=s.magnitude();return n<=e.radius+t.radius?(s.divideMut(n),new Z(t.center.add(s.multiply(t.radius)),s)):0})(t,e);case 1:return et(t,e);case 2:return tt(t,e)}case 1:switch(e.getType()){case 0:return et(e,t);case 1:case 2:return 0}case 2:switch(e.getType()){case 0:return tt(e,t);case 1:case 2:return 0}}};class nt extends r{constructor(){super(""),this.kind=this.constructor.name}}class at extends nt{}class it extends nt{}class ot extends nt{}class rt extends nt{}class ct extends nt{}class lt extends nt{}class ht extends nt{}class ut extends nt{}class dt extends nt{}class ft extends nt{}class mt extends nt{}class gt extends nt{}class yt extends nt{}class pt extends r{constructor(t){super(pt.name),this._render=t}render(t,e){e.save(),this._render(t,e,n(this.entity)),e.restore()}}class vt extends r{constructor(t,e){super(t),this.value=e}setValue(t){this.value.copyFrom(t)}}class xt extends vt{constructor(t){super(xt.name,t)}}class wt{constructor(t,e,s,n,a){this.entityA=t,this.shapeA=e,this.entityB=s,this.shapeB=n,this.hit=a}}class bt extends r{constructor(t,e,s=1){super(bt.name),this.shapes=t,this.onFn=e,this.group=s,this.on=(t,e)=>{this.onFn(n(this.entity),t,e)},this.globalShapes=t.map((t=>t.clone())),this.aabbOriginal=q.create(E.create(),E.create()),this.shapes.forEach((t=>this.aabbOriginal.merge(t.getAABB()))),this.aabb=this.aabbOriginal.clone()}move(t,e){return this.shapes.forEach(((s,n)=>{const a=s.clone();a.move(t,e),this.globalShapes[n]=a})),this.aabbOriginal=l(this.globalShapes).getAABB().clone(),this.globalShapes.forEach((t=>this.aabbOriginal.merge(t.getAABB()))),this.aabb=this.aabbOriginal.clone(),this}}class _t extends r{constructor(t){super(_t.name),this.shapes=t}}const St="#27c6dc",Pt=(t,e=1)=>{const s=[];for(let n=0;n<=t.x;n+=100)s.push(E.create(n,t.y/2+y(n/t.x*_*e)*t.y/2+y(n/t.x*_*e*4)*t.y/4));return s},Tt=(t,e,s)=>{const n=K.create(s),a=new bt([n.clone()],(()=>{}),4);return a.move(e,0),t.createEntity().add(new _t([n])).add(new xt(e)).add(new ft).add(new pt(((t,e,s)=>{const n=s.get(xt),{shapes:a}=s.get(_t),{points:i}=l(a);e.translate(n.value.x,n.value.y),e.fillStyle="#000",e.beginPath();for(const o of i)e.lineTo(o.x,o.y);e.fill()}))).add(a)};class Rt extends r{constructor(t=2e3){super(Rt.name),this.time=new X(t)}}class Mt extends r{constructor(t){super(Mt.name),this._step=t}step(t){this._step(t,n(this.entity))}}class kt{constructor(){this.force=E.create(),this.angle=0}}var Et=(t=>(t[t.Left=-1]="Left",t[t.Right=1]="Right",t))(Et||{});class At extends r{constructor(t=1){super(At.name),this.facing=t,this.radius=35,this.propellerAngle=0,this.simplifiedPhysics=0,this.propellerPower=0,this.momentum=new kt,this.landed=0,this.landedTime=0,this.lastLanded=0,this.damagedStart=0,this.damagedEnd=0,this.lockDuration=1,this.lastCollisionSound=0,this.uncontrollableDuration=1}}class Ct extends vt{constructor(t,e){super(Ct.name,t),this.maxSpeed=e}}class Bt extends r{constructor(t){super(Bt.name),this.rotation=t}}class zt extends vt{constructor(t){super(zt.name,t)}}class Gt extends r{constructor(t,e=1){super(Gt.name),this.colour=t,this.alpha=e}}class Dt extends r{constructor(t){super(Dt.name),this.easings=t}step(t){this.easings.forEach((e=>e.step(t)))}}const Ot=(t,e,s)=>{const n=s.get(xt),a=s.get(zt),i=s.get(Gt);e.translate(n.value.x,n.value.y),e.rotate(w/4),e.fillStyle=i.colour,e.globalAlpha=i.alpha,e.fillRect(-a.value.x/2,-a.value.y/2,a.value.x,a.value.y)},Ft=(t,e,s,n,a,i,o)=>t.createEntity().add(new xt(a.clone())).add(new ft).add(new zt(E.create(s,s))).add(new Gt(e)).add(new pt(Ot)).add(new Mt(((t,e)=>{const o=e.get(Dt).easings[0],r=e.get(xt),c=e.get(zt),l=e.get(Gt);r.value.x=o.interpolate(a.x,i.x),r.value.y=o.interpolate(a.y,i.y),c.value.x=o.interpolate(s,n),c.value.y=o.interpolate(s,n),l.alpha=1-o.current,o.timer.isDone()&&e.remove()}))).add(new Dt([new V(o,Y)])),Lt=(t,e,s,n,a,i=["#ff0","#f80","#000"])=>{const o=new X(1/30),r=new X(a),c=.6*a;return t.createEntity().add(new xt(e)).add(new Ct(E.create(T(-15,15),T(-30,-40)),s)).add(new Bt(n)).add(new Mt(((e,s)=>{const n=s.get(Ct),l=s.get(Bt),h=s.get(xt);r.step(e),o.step(e);let u=n.value.magnitude(),d=y(l.rotation);if(d+=S(-e/1e3,1-d,e/1e3),l.rotation=g(d,p(l.rotation)),n.value.x=p(l.rotation)*e/5.2*u,n.value.y=y(l.rotation)*e/5.2*u,o.isDone()){o.reset();const e=Math.max(0,(a-r.age)/(a-c)),s=T(4,8)*e;if(s>1){const e=l.rotation+T(-.3,.3),n=T(8,12),a=T(200,300),o=200,r=E.create(h.value.x+Math.cos(e)*n,h.value.y+Math.sin(e)*n+o*(a/1e3)*(a/1e3)/2);Ft(t,M(i),s,0,h.value.clone(),r,a)}}r.isDone()&&s.remove()})))},{sin:It,PI:qt,pow:jt,random:Wt,floor:Xt,round:Yt}=Math,Ht=t=>It(t*qt*2),Nt=[Ht,t=>Ht(t)<0?-1:1,t=>t%1-.5,t=>{const e=t%1*4;return e<2?e-1:3-e}],Ut=(t,e)=>(t=>.00390625*jt(1.059463094,t-128))(e)/t.sampleRate*44100,Vt=(t,e)=>Yt(60*t.sampleRate/4/e);class Jt{constructor(t,e,s,n){this.audioCtx=t,this.instr=e,this.n=s,this.bpm=n,this.c1=0,this.c2=0,this.low=0,this.band=0,this.j=0}write(t,e,s){const n=this.instr,a=this.n;let i=s;const o=Nt[n.lfo_waveform],r=Nt[n.osc1_waveform],c=Nt[n.osc2_waveform],l=jt(2,n.fx_pan_freq-8)/Vt(this.audioCtx,this.bpm),h=jt(2,n.lfo_freq-8)/Vt(this.audioCtx,this.bpm),u=n.env_attack/44100,d=n.env_release/44100,f=n.env_sustain/44100,m=u*this.audioCtx.sampleRate,g=d*this.audioCtx.sampleRate,y=f*this.audioCtx.sampleRate,p=Ut(this.audioCtx,a+12*(n.osc1_oct-8)+n.osc1_det)*(1+8e-4*n.osc1_detune),v=Ut(this.audioCtx,a+12*(n.osc2_oct-8)+n.osc2_det)*(1+8e-4*n.osc2_detune),x=n.fx_resonance/255;for(;this.j<m+y+g&&i<t.length;){const s=o(this.j*h)*n.lfo_amt/512+.5;let a=1;this.j<m?a=this.j/m:this.j>=m+y&&(a-=(this.j-m-y)/g);let u=p;n.lfo_osc1_freq&&(u+=s),n.osc1_xenv&&(u*=a*a),this.c1+=u;let d=r(this.c1)*n.osc1_vol;u=v,n.osc2_xenv&&(u*=a*a),this.c2+=u,d+=c(this.c2)*n.osc2_vol,n.noise_fader&&(d+=(2*Wt()-1)*n.noise_fader*a),d*=a/255;let f=n.fx_freq;n.lfo_fx_freq&&(f*=s),f=1.5*It(f*qt/this.audioCtx.sampleRate),this.low+=f*this.band;const w=x*(d-this.band)-this.low;switch(this.band+=f*w,n.fx_filter){case 1:d=w;break;case 2:d=this.low;break;case 3:d=this.band;break;case 4:d=this.low+w}u=Ht(this.j*l)*n.fx_pan_amt/512+.5,d*=39*n.env_master;let b=32768+d*(1-u),_=255&b,S=b>>8&255,P=4*(_+(S<<8)-32768);P=P<-32768?-32768:P>32767?32767:P,t[i]=t[i]+P/32768,b=32768+d*u,_=255&b,S=b>>8&255,P=4*(_+(S<<8)-32768),P=P<-32768?-32768:P>32767?32767:P,e[i]=e[i]+P/32768,this.j++,i++}return i<t.length}}class Kt{constructor(t,e,s,n){s=s||118,n=n||e.p.length-1,this.audioCtx=t,this.instr=e,this.bpm=s,this.endPattern=n;const a=this.audioCtx.createOscillator(),i=this.audioCtx.createGain();i.gain.value=0,a.connect(i);const o=this.audioCtx.createScriptProcessor(512,2,2);i.connect(o);let r=0,c=0,l=[];o.onaudioprocess=t=>{const s=t.inputBuffer,n=t.outputBuffer,a=n.getChannelData(0),i=n.getChannelData(1);a.set(s.getChannelData(0)),i.set(s.getChannelData(1)),l.slice().forEach((t=>{t.write(a,i,0)&&(l=l.filter((e=>e!==t)))}));let o=c*Vt(this.audioCtx,this.bpm);for(;o>=r&&o<r+s.length;){const t=e.p[Xt(c/32)%(this.endPattern+1)]||0,s=0===t?0:(e.c[t-1]||{n:[]}).n[c%32]||0;if(0!==s){const t=new Jt(this.audioCtx,e,s,this.bpm);t.write(a,i,o-r),l.push(t)}c+=1,o=c*Vt(this.audioCtx,this.bpm)}r+=s.length};const h=e.fx_delay_time*(1/(this.bpm/60)/8),u=e.fx_delay_amt/255,d=this.audioCtx.createGain();d.gain.value=u,o.connect(d);const f=this.audioCtx.createDelay();f.delayTime.value=h,d.connect(f),f.connect(d);const m=this.audioCtx.createGain();m.gain.value=1,o.connect(m),f.connect(m),this.chain=[a,i,o,d,f,m]}start(t){this.chain[0].start(t)}stop(t){this.chain[0].stop(t),this.chain[this.chain.length-1].disconnect()}connect(t){this.chain[this.chain.length-1].connect(t)}}class $t{constructor(t,e){this.audioCtx=t,this.song=e;const s=this.audioCtx.createGain();s.gain.value=1,this.tracks=[],this.song.songData.forEach((t=>{const e=new Kt(this.audioCtx,t,this.bpm,this.song.endPattern);e.connect(s),this.tracks.push(e)})),this.chain=[this.tracks,s]}get bpm(){return Yt(661500/this.song.rowLen)}start(t){t=t||this.audioCtx.currentTime,this.tracks.forEach((e=>e.start(t)))}stop(t){t=t||this.audioCtx.currentTime,this.tracks.forEach((e=>e.stop(t))),this.chain[this.chain.length-1].disconnect()}connect(t){this.chain[this.chain.length-1].connect(t)}}async function Qt(t,e){const s=t.songLen,n=new OfflineAudioContext(2,s*e,e),a=new $t(n,t);return a.connect(n.destination),a.start(),await n.startRendering()}const Zt={volume:.3,sampleRate:44100,x:new AudioContext,play(...t){return this.playSamples(this.buildSamples(...t))},playSamples(...t){const e=this.x.createBuffer(t.length,t[0].length,this.sampleRate),s=this.x.createBufferSource();return t.map(((t,s)=>e.getChannelData(s).set(t))),s.buffer=e,s.connect(this.x.destination),s.start(),s},buildSamples(t=1,e=.05,s=220,n=0,a=0,i=.1,o=0,r=1,c=0,l=0,h=0,u=0,d=0,f=0,m=0,g=0,y=0,p=1,v=0,x=0,w=0){let b,_,S=2*Math.PI,P=t=>t<0?-1:1,T=this.sampleRate,R=c*=500*S/T/T,M=s*=(1+2*e*Math.random()-e)*S/T,k=[],E=0,A=0,C=0,B=1,z=0,G=0,D=0,O=S*Math.abs(w)*2/T,F=Math.cos(O),L=Math.sin(O)/2/2,I=1+L,q=-2*F/I,j=(1-L)/I,W=(1+P(w)*F)/2/I,X=-(P(w)+F)/I,Y=W,H=0,N=0,U=0,V=0;for(n=n*T+9,v*=T,a*=T,i*=T,y*=T,l*=500*S/T**3,m*=S/T,h*=S/T,u*=T,d=d*T|0,t*=this.volume,_=n+v+a+i+y|0;C<_;k[C++]=D*t)++G%(100*g|0)||(D=o?o>1?o>2?o>3?Math.sin(E**3):Math.max(Math.min(Math.tan(E),1),-1):1-(2*E/S%2+2)%2:1-4*Math.abs(Math.round(E/S)-E/S):Math.sin(E),D=(d?1-x+x*Math.sin(S*C/d):1)*P(D)*Math.abs(D)**r*(C<n?C/n:C<n+v?1-(C-n)/v*(1-p):C<n+v+a?p:C<_-y?(_-C-y)/i*p:0),D=y?D/2+(y>C?0:(C<_-y?1:(_-C)/y)*k[C-y|0]/2/t):D,w&&(D=V=Y*H+X*(H=N)+W*(N=D)-j*U-q*(U=V))),b=(s+=c+=l)*Math.cos(m*A++),E+=b+b*f*Math.sin(C**5),B&&++B>u&&(s+=h,M+=h,B=0),!d||++z%d||(s=M,c=R,B=B||1);return k},getNote:(t=0,e=440)=>e*2**(t/12)};var te=function(){function t(t,e){this.gainNode=t,this.source=e}return t.prototype.setVolume=function(t){this.gainNode.gain.value=t},t.prototype.stop=function(){this.source.stop()},t.prototype.start=function(){this.source.start()},t}();class ee extends r{constructor(t=1){super(ee.name),this.zoom=t,this.float_pos=E.create(),this.int_pos=E.create(),this.bufferCanvas=document.createElement("canvas"),this.bufferContext=this.bufferCanvas.getContext("2d")}setPos(t){this.float_pos.copyFrom(t),this.int_pos.copyFrom(t).clapMut()}}class se extends r{constructor(t,e){super(se.name),this.power=t,this.duration=e,this.full=new X(e),this.nextShake=new X(1e3/60)}reset(){this.full.reset(),this.nextShake.reset()}}const ne=(t,e,s,n)=>{!function(...t){Zt.play(...t)}(...[,,125,.02,.4,.3,2,2.7,-.6,-15,,,,1.8,,.15,.3,.5,.35]);for(let o=0;o<6;o++)Lt(t,E.create(e.x+T(.4*-s,.4*s),e.y+T(.4*-s,.4*s)),T(15,35),-T(w/4,3*w/4),800,n);const a=n||["#000","#ff0","#f80"];for(let o=0;o<15;o++){const n=o/15*w*2,i=T(.3*s,.6*s),r=e.x+Math.cos(n)*i,c=e.y+Math.sin(n)*i;Ft(t,M(a),T(21,51),0,E.create(r,c),E.create(r+Math.cos(n)*T(80,120),c+Math.sin(n)*T(80,120)),T(600,1e3))}const i=t.get(ee);for(const o of i){const{entity:s}=o,n=t.tryGet(dt);if(!n)return;for(const t of n){if(t.isRemoved())continue;const n=t.entity.get(xt).value.distPow2(e);if(n<25e4){const t=1-n/25e4,e=s.tryGet(se);e&&e.power<t?e.remove():s.add(new se(t,300))}}}},ae=t=>t.createEntity().add(new rt),ie=(t,e,s=0)=>{const a=[E.create(-150,2e3),E.create(-125,-20),E.create(-75,0),E.create(75,0),E.create(125,-20),E.create(150,2e3)],i=((t,e)=>{const s=new $(E.create(),E.create(75,15)),n=new bt([s],((t,e,s)=>{if(!e.tryGet(dt))return;const n=e.get(At),a=Math.abs(n.momentum.force.y),i=e.get(bt),o=s.entityA===t?s.shapeA:s.shapeB;i.globalShapes.indexOf(o)<=1&&(a>=.4?(ne(e.world,e.get(xt).value.clone(),100),e.remove(),setTimeout((()=>ae(e.world)),3e3)):n.landed=1)}),4);return n.move(e.clone(),0),t.createEntity().add(new xt(e.clone())).add(new _t([s])).add(n).add(new pt(((e,s,n)=>{const a=n.get(_t),i=n.get(xt),o=a.shapes[0];s.fillStyle="#00f",s.fillRect(i.value.x+o.center.x-o.halfSize.x,i.value.y+o.center.y-o.halfSize.y,2*o.halfSize.x,2*o.halfSize.y),s.fillStyle="#fff";const r=Math.floor(2*o.halfSize.x/20);for(let t=0;t<r;t++){const e=i.value.x+o.center.x-o.halfSize.x+20*t;s.fillRect(e,i.value.y+o.center.y-o.halfSize.y,8,2*o.halfSize.y)}const c=n.tryGet(Rt);if(c){const e=c.time.getProgress();s.fillStyle="#00E5FF",s.fillRect(i.value.x+o.center.x-o.halfSize.x,i.value.y+o.center.y-o.halfSize.y,2*o.halfSize.x*e,2*o.halfSize.y),c.time.isDone()&&(t=>{t.createEntity().add(new mt)})(t)}}))).add(new ht)})(t,e.subtract(E.create(0,10)));return s&&(i.add(new ct),i.add(new Rt(2e3)),i.add(new Mt(((e,s)=>{const a=t.tryGet(dt);if(a)for(const t of a){if(t.isRemoved())return;const a=n(t.entity);if(a.get(At).landed){const t=a.get(xt),n=s.get(xt);t.value.distPow2(n.value)<1e4&&s.get(Rt).time.step(e)}}})))),[Tt(t,e.clone(),a),i]},oe=E.create(200,0),re=oe.divide(2),ce=(t,e,s,n)=>{const a=Pt(s.subtract(oe),n).map((t=>t.addMut(re)));return a.splice(0,0,E.create(0,2e3)),a.push(E.create(s.x,2e3)),Tt(t,e,a).add(new it)},le=E.create(200,0),he=le.divide(2),ue=(t,e,s,n=1)=>{const a=Pt(s.subtract(le),n).map((t=>t.addMut(he)));return a.splice(0,0,E.create(0,-2e3)),a.push(E.create(s.x,-2e3)),Tt(t,e,a).add(new ot)};class de extends r{constructor(){super(de.name),this.down=0,this.left=0,this.right=0,this.shoot=0,this.up=0}reset(){this.down=0,this.left=0,this.right=0,this.shoot=0,this.up=0}}class fe extends r{constructor(t,e,s=6e3){super(fe.name),this.targetTag=t,this.shouldTarget=e,this.targetingInterval=s,this.lockedTarget=null,this.lockedTargetAcquireAngle=w/8,this.lockedTargetKeepAngle=w/4,this.radius=20,this.target=new X(s),this.load=new X(1e3)}}class me extends r{constructor(){super(me.name),this.maxLength=100,this.length=0,this.grabbingLadderRatio=0}}class ge extends r{constructor(){super(ge.name),this.rescuedPrisoners=0}}const ye=(t,e,s,n,a)=>{t.save(),t.rotate(a),t.fillRect(-e/2,-s/2,e,s);const i=U(w/12,w/4,n);t.globalAlpha=.12,t.beginPath(),t.moveTo(0,0),t.arc(0,0,e/2,0,-i,1),t.rotate(w),t.moveTo(0,0),t.arc(0,0,e/2,0,-i,1),t.fill(),t.restore()},pe=(t,e,s)=>{const{value:n}=s.get(xt),{rotation:a}=s.get(Bt),i=s.get(At);e.translate(n.x,n.y),e.rotate(a),e.scale(i.facing,1),e.fillStyle="#000",e.strokeStyle="#000",e.lineWidth=2,e.lineJoin="round",e.lineCap="round",e.beginPath(),e.moveTo(-20,-10),e.quadraticCurveTo(-15,-18,0,-18),e.quadraticCurveTo(15,-18,20,-10),e.lineTo(20,5),e.quadraticCurveTo(15,12,0,12),e.quadraticCurveTo(-15,12,-20,5),e.closePath(),e.fill(),e.beginPath(),e.moveTo(-18,0),e.lineTo(-55,-8),e.lineTo(-60,-12),e.lineTo(-55,-16),e.lineTo(-50,-12),e.fill(),e.beginPath(),e.moveTo(15,-8),e.quadraticCurveTo(10,-14,0,-14),e.quadraticCurveTo(-10,-14,-15,-8),e.strokeStyle="#000",e.lineWidth=1,e.stroke(),e.lineWidth=3,e.beginPath(),e.moveTo(-15,20),e.lineTo(5,20),e.moveTo(15,20),e.lineTo(-5,20),e.stroke(),e.lineWidth=2,e.beginPath(),e.moveTo(-5,12),e.lineTo(-5,20),e.moveTo(5,12),e.lineTo(5,20),e.stroke(),e.fillRect(-2,-18,4,-4),e.save(),e.translate(0,-22),e.scale(1,.45),ye(e,100,6,i.propellerPower,i.propellerAngle),e.restore(),e.save(),e.translate(-55,-15),ye(e,24,4,i.propellerPower,i.propellerAngle),e.restore()},ve=(t,e,s)=>{if(!s.hit.pos)return;const n=!!t.tryGet(ht),a=!!e.tryGet(ht),i=n?e:t;if(n||a){const e=i.get(bt),n=i.get(At),a=s.entityA===t?s.shapeA:s.shapeB;if(e.globalShapes.indexOf(a)<=1)return void(n.landed=1)}if(t.tryGet(dt)){const{world:e}=t;setTimeout((()=>ae(e)),3e3)}t.remove(),ne(t.world,s.hit.pos,100)};class xe extends vt{constructor(t){super(xe.name,t)}}class we extends r{constructor(){super(we.name),this.value=new W}}class be extends r{constructor(t,e=0){super(be.name),this.target=t,this.autoMove=e}}const _e=t=>{ne(t.world,t.get(xt).value.clone(),80),t.remove()},Se=(t,e)=>{const{group:s}=e.get(bt);3!==s&&_e(t)},Pe=(t,e)=>{if(e.get(we).value.age>2e3)return void _e(e);const s=e.tryGet(be),n=e.get(xt).value,a=e.get(Bt);if(s?.target&&!s?.target.isRemoved()){const i=s.target.get(xt),o=e.get(xe).value,r=_/t,c=n.angle(i.value);a.rotation+=S(-r,c-a.rotation,r),o.rotate(c-a.rotation)}const i=l(e.get(Dt).easings);i.timer.isDone()&&(i.timer.reset(),Ft(e.world,"#fff",T(5,10),T(10,20),n.clone(),n.add(E.create(T(-10,10),T(-10,10))),T(1200,3e3)))},Te=(t,e,s,n,a,i)=>t.createEntity().add(new we).add(new xt(e.addMut(E.create(1,0).rotateMut(i).multiplyMut(20)))).add(new Ct(s,40)).add(new xe(n)).add(new bt([new Q(E.create(),10)],Se,5)).add(new Bt(i)).add(new Dt([new V(1e3/60,Y)])).add(new Mt(Pe)),Re=1e-6,Me=E.create(400*Re,400*Re),ke=50*Re,Ee=200*Re,Ae=4e5*Re,Ce=2e5*Re,Be=200*Re,ze=15e-5,Ge=(t,e)=>{const{world:s}=e,n=e.get(de),a=e.get(xt),i=e.get(Bt),o=e.get(At),r=s.tryGet(gt);if(!r)return;const c=r[0].entity.get(xt);if(a.value.y>c.value.y)return ne(s,a.value.clone(),100,[St]),e.remove(),void setTimeout((()=>ae(s)),3e3);o.propellerAngle+=U(3,5,o.propellerPower)*w*t;const l=e.get(fe);if(l.load.isDone()&&n.shoot){let t,e=i.rotation;if(l.lockedTarget&&l.target.isDone()){const s=l.lockedTarget.get(xt);e=a.value.angle(s.value),t=l.lockedTarget}const n=E.fromAngle(e),o=Te(s,n.multiply(50).add(a.value),n.multiply(30),n.multiplyMut(20),Et.Left,e);t&&o.add(new be(t,0)),l.load.reset()}n.left,n.right,n.up,n.down;let u=0,d=w/6;o.landed||(n.left&&(u=-w/4),n.right&&(u=w/4),(n.left||n.right)&&(d=w/1.5));const g=t/1e3,v=n.up?1:0;o.propellerPower+=S(4*-g,v-o.propellerPower,4*g),i.rotation+=S(-g*d,u-i.rotation,g*d),o.momentum.angle=0,o.simplifiedPhysics?(o.momentum.force.x+=p(u-w/2)*t*Me.x,o.momentum.force.y-=o.propellerPower*t*Me.y):(o.momentum.force.x+=U(.5,1.5,o.propellerPower)*p(i.rotation-w/2)*t*Me.x,o.momentum.force.y+=o.propellerPower*y(i.rotation-w/2)*t*Me.y);const x=Math.sign(y(i.rotation))!==Math.sign(o.momentum.force.x)||o.simplifiedPhysics?ke:Ee;o.momentum.force.x+=S(-t*x,-o.momentum.force.x,t*x);const b=o.simplifiedPhysics?n.left||n.right?.02:Ce:Ae,_=o.simplifiedPhysics?Be:n.down?3e-4:ze;o.momentum.force.y+=S(-t*(o.simplifiedPhysics?ze:Be),b-o.momentum.force.y,t*_),o.simplifiedPhysics&&(o.momentum.force.x=S(-3,o.momentum.force.x,3),o.momentum.force.y=S(-3,o.momentum.force.y,2)),o.landed&&h(o.propellerPower)<.1?o.momentum.force.y=0:o.propellerPower>0&&(o.landed=0),a.value.x+=o.momentum.force.x*t,a.value.y+=o.momentum.force.y*t,a.value.x=m(I.min.x,a.value.x),a.value.y=f(I.max.y,a.value.y),i.rotation+=o.momentum.angle*t,i.rotation=S(-w/4,i.rotation,w/4),e.get(bt).move(a.value.clone(),i.rotation)},De=(t,e,s)=>{const n=((t,e,s,n,a=1e3)=>{const i=[Q.create(E.create(-5,20),3),Q.create(E.create(5,20),3),Q.create(E.create(0,-3),15),Q.create(E.create(-15,0),12),Q.create(E.create(15,0),12),Q.create(E.create(-55,-12),8)],o=s===Et.Right?1:-1;return i.forEach((t=>t.center.x*=o)),t.createEntity().add(new pt(pe)).add(new xt(e)).add(new Bt(0)).add(new At(s)).add(new ge).add(new bt(i,ve,2)).add(new fe(n,(()=>0),a)).add(new me)})(t,e,s,yt);return n.get(bt).group=2,n.add(new dt).add(new de).add(new Mt(Ge)).add(new fe(yt,((t,e)=>{const s=e.get(xt),n=t.get(xt);return s.value.distPow2(n.value)<25e4}),6)).add(new ft)};class Oe extends r{constructor(t){super(Oe.name),this.context=t}}const Fe=(t,e)=>{const s=e.get(ee),a=e.get(xt),i=e.tryGet(be);if(!i||i.isRemoved()||i.target?.isRemoved())return;const o=n(i.target).get(xt),r=S(I.min.x,o.value.x,I.max.x),c=S(I.min.y,o.value.y,I.max.y),l=.05*h(r-a.value.x),u=.05*h(c-a.value.y);a.value.x+=S(-l,r-a.value.x,l),a.value.y+=S(-u,c-a.value.y,u),a.value.x=S(I.min.x,a.value.x,I.max.x),a.value.y=S(I.min.y,a.value.y,I.max.y),s.setPos(a.value)},Le=(t,e,s,n=1)=>t.createEntity().add(new Oe(e)).add(new xt(s)).add(new ee(n)).add(new ft).add(new Mt(Fe)),Ie=t=>t.createEntity().add(new at),qe=t=>{Ie(t)},je=(t,e,s)=>{ie(t,s.clone());const n=De(t,s.subtract(E.create(0,50)),Et.Right);return Le(t,e,s).add(new be(n,0)),n},We=(t,e)=>ie(t,e,1),Xe=t=>{const e=t.tryGet(bt);if(!e)return;const s=q.create(E.create(),E.create());e.forEach((t=>s.merge(t.aabb))),I.setBounds(s.center.subtract(s.halfSize.add(E.create(1e3,200))),s.center.addMut(s.halfSize.addMut(E.create(1e3,200))))},Ye=(t,e)=>{let s=-1;const n=t.tryGet(it);for(const a of n){if(a.isRemoved())continue;const t=a.entity.get(xt),n=a.entity.get(bt);if(P(n.aabb.minX,e,n.aabb.maxX)){const a=e-n.aabb.minX;s=n.shapes.reduce(((t,e)=>{const s=e.yAt(a);return null==t?s:null==s?t:t<s?s:t}),null),s+=t.value.y-10}}return((t,e)=>t.createEntity().add(new xt(e)).add(new bt([new Q(E.create(),10)],((t,e)=>{const{group:s}=e.get(bt);5===s&&(ne(t.world,t.get(xt).value.clone(),80,["#f00"]),t.remove())}),3).move(e,0)).add(new ft).add(new Mt(((t,e)=>{const s=e.get(fe),n=e.get(Bt);if(s.load.isDone()&&s.target.isDone()&&s.lockedTarget){if(s.target.isDone()){const t=e.get(Bt),a=e.get(xt),i=s.lockedTarget.get(xt),o=a.value.x+30*p(n.rotation),r=a.value.y+30*y(n.rotation),c=i.value.subtract(a.value).normalizeMut();Te(e.world,E.create(o,r),c.multiply(40),c.multiplyMut(40),Et.Left,t.rotation),s.load.reset()}}else n.rotation=w}))).add(new pt(((t,e,s)=>{const n=s.get(fe),a=s.get(Bt),i=s.get(xt);e.translate(i.value.x,i.value.y);const o=n.target.getProgress();if(o>0){e.save(),e.fillStyle="#ff0",e.globalAlpha=U(0,.5,o);const t=U(1,0,o);e.scale(t,t),e.beginPath(),e.arc(0,0,40,0,2*w),e.fill(),e.restore()}e.fillStyle=e.strokeStyle="#000",e.scale(.8,.8),e.beginPath(),e.arc(0,-12,4,0,2*w),e.fill(),e.lineJoin="round",e.lineCap="round",e.lineWidth=3,e.beginPath(),e.save(),e.translate(0,-4),e.rotate(a.rotation),e.moveTo(-8,2),e.restore(),e.lineTo(-5,-5),e.lineTo(5,-5),e.save(),e.translate(0,-4),e.rotate(a.rotation),e.lineTo(8,2),e.restore(),e.stroke(),e.lineWidth=4,e.beginPath(),e.moveTo(-3,0),e.lineTo(-3,16),e.moveTo(3,0),e.lineTo(3,16),e.stroke(),e.fillRect(-5,-8,10,16),e.save(),e.translate(0,-4),e.rotate(a.rotation),e.fillStyle="#f00",e.fillRect(-10,-2.5,24,5),e.restore()}))).add(new fe(dt,((t,e)=>{const s=t.get(fe),n=t.get(Bt),a=e.get(xt),i=t.get(xt);return n.rotation=i.value.angle(a.value),s.target.getProgress(),a.value.distPow2(i.value)<25e4}),1e3)).add(new Bt(w)).add(new yt))(t,E.create(e,s))},He=(t,e)=>((t,e,s)=>"#"+(t<<16|e<<8|s).toString(16).padStart(6,"0"))(...(t=>{const e=(t=>{const e=t.slice(1);return parseInt(3===e.length?e.split("").map((t=>t.repeat(2))).join():e,16)})(t);return[(e>>16)%256,(e>>8)%256,(0|e)%256]})(t).map((t=>t*e))),Ne=(t,e,s)=>{const a=document.createElement("canvas"),i=n(a.getContext("2d"));return a.width=t,a.height=e,s(a,i),a};class Ue{constructor(t,e,s,n="#000",a=1){this.pattern=t,this.width=e,this.height=s,this.colour=n,this.factor=a}}const Ve=(t,e,s)=>{let a;return Ne(t,e,((t,e)=>{s(t,e),a=n(e.createPattern(t,"repeat"))})),new Ue(n(a),t,e)},Je=(t,e)=>{const s=[.8,.6,.4].map((t=>{const s=He(e,t),n=Ve(400,100,(t=>(e,s)=>{s.fillStyle=t;const n=800*u(),a=800*u();s.beginPath(),s.moveTo(0,400);for(let t=0;t<=800;t+=100)s.lineTo(t,50+25*y((t+n)/400*w*2)+12*y((t+a)/200*w*2));s.lineTo(800,400),s.fill()})(s));return n.colour=s,n.factor=t,n}));return t.createEntity().add(new pt(((t,e)=>{let n=200;for(let a=0;a<s.length;a++){const i=s[a],o=(a+2)/(s.length+1),r=U(.3,.8,o),c=U(.1,.1,o);e.save();const l=~~(t.int_pos.y*c+n);e.translate(~~(t.int_pos.x-I.halfWidth),l),e.save();const h=~~(t.float_pos.x*r);e.translate(-h,0),e.fillStyle=i.pattern,e.fillRect(h,0,I.width,i.height),e.restore(),e.fillStyle=i.colour,e.fillRect(0,i.height,I.width,t.int_pos.y+I.height-l-200),e.restore(),n+=50}})))};class Ke extends r{constructor(t){super(Ke.name),this._onResize=t}onResize(){this._onResize(n(this.entity))}}const $e=(t,e,s)=>{const a=n(document.createElement("canvas").getContext("2d"));let i;const o=()=>{i=a.createLinearGradient(0,0,0,I.height),i.addColorStop(0,e),i.addColorStop(1,s)};return o(),t.createEntity().add(new pt(((t,e)=>{e.translate(~~(t.int_pos.x-I.halfWidth),~~(t.int_pos.y-I.halfHeight)),e.fillStyle=i,e.fillRect(0,0,~~I.width,~~I.height)}))).add(new Ke(o))},Qe=(t,e)=>{const s=[.8,1].map((t=>{const e=He(St,t),s=Ve(100,20,((t,s)=>{s.fillStyle=e,s.beginPath(),s.moveTo(0,20);for(let e=0;e<=100;e+=2)s.lineTo(e,10+10*h(y(e/100*w*2)));s.lineTo(100,20),s.fill()}));return s.colour=e,s.factor=t,s}));return t.createEntity().add(new we).add(new xt(E.create(0,e))).add(new pt(((t,e,n)=>{const a=n.get(xt);if(t.float_pos.y+I.height/2<a.value.y)return;e.translate(~~t.float_pos.x-I.width/2,a.value.y);let i=0,o=50;const r=n.get(we);for(const c of s){e.save();const s=r.value.age/1e3*o-t.float_pos.x;e.translate(s,i),e.fillStyle=c.pattern,e.fillRect(-s,0,I.width,100),e.fillStyle=c.colour,e.fillRect(-s,c.height,I.width,1e3),e.restore(),i+=20,o*=1.1}}))).add(new gt)},Ze=(t,e)=>t.createEntity().add(new pt(((t,s)=>{s.translate(~~(.9*t.float_pos.x+I.width/4),~~(.1*t.float_pos.y)),s.fillStyle=e,s.beginPath(),s.arc(0,0,200,0,_),s.fill()})));class ts extends r{constructor(t){super(ts.name),this.text=t}}const es=(t,e,s)=>t.createEntity().add(new ts(s)).add(new xt(e)).add(new pt(((t,e,n)=>{const a=n.get(xt),i=n.get(Dt),o=i.easings[0].interpolate(0,.3),r=i.easings[1].interpolate(-25,0);e.translate(a.value.x,a.value.y),e.fillStyle="#000",e.textAlign="center",e.textBaseline="middle",e.font="bold 48pt Impact",e.globalAlpha=o,e.translate(0,r),e.fillText(s,0,25)}))).add(new Dt([new V(1e3,Y),new V(1e3,H)])).add(new lt);class ss extends r{constructor(t,e){super(ss.name),this.style=t,this.content=e}}const ns=(t,e,s="rgba(0,0,0,0)",n="#000")=>{const a=Ne(I.width,3+~~I.height,((t,s)=>{s.fillStyle=n,s.fillRect(0,-1,~~I.width,3+~~I.height),s.globalCompositeOperation="destination-out",s.textAlign="center",s.textBaseline="middle",s.font="bold 148pt Impact",e.split("\n").forEach(((t,e)=>s.fillText(t,I.halfWidth,I.halfHeight-100+200*e)))}));return t.createEntity().add(new ts(e)).add(new pt(((t,e)=>{e.translate(~~(t.float_pos.x-I.halfWidth),~~(t.float_pos.y-I.halfHeight)-1),e.fillStyle=s,e.fillRect(0,-1,~~I.width,3+~~I.height),e.drawImage(a,0,-1)})))},as={rowLen:6300,endPattern:11,songData:[{osc1_oct:5,osc1_det:0,osc1_detune:0,osc1_xenv:0,osc1_vol:192,osc1_waveform:2,osc2_oct:4,osc2_det:0,osc2_detune:12,osc2_xenv:0,osc2_vol:192,osc2_waveform:3,noise_fader:0,env_attack:500,env_sustain:2e3,env_release:8e3,env_master:200,fx_filter:2,fx_freq:8e3,fx_resonance:200,fx_delay_time:4,fx_delay_amt:80,fx_pan_freq:4,fx_pan_amt:80,lfo_osc1_freq:0,lfo_fx_freq:1,lfo_freq:4,lfo_amt:150,lfo_waveform:0,p:[2,2,3,3,2,2,3,3,4,5],c:[{n:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{n:[161,0,164,0,161,0,164,0,168,0,164,0,163,0,161,0,161,0,164,0,168,0,171,0,166,0,164,0,163,0,161,0]},{n:[168,0,166,0,164,0,163,0,161,0,163,0,164,0,166,0,168,0,171,0,173,0,171,0,168,0,166,0,164,0,163,0]},{n:[164,0,163,0,161,0,163,0,166,0,164,0,163,0,161,0,168,0,166,0,164,0,163,0,161,0,163,0,164,0,166,0]},{n:[168,0,171,0,173,0,171,0,168,0,166,0,164,0,163,0,164,0,166,0,168,0,171,0,173,0,171,0,168,0,166,0]}]},{osc1_oct:7,osc1_det:0,osc1_detune:0,osc1_xenv:1,osc1_vol:150,osc1_waveform:0,osc2_oct:6,osc2_det:0,osc2_detune:0,osc2_xenv:1,osc2_vol:150,osc2_waveform:0,noise_fader:255,env_attack:50,env_sustain:150,env_release:2e3,env_master:80,fx_filter:2,fx_freq:800,fx_resonance:200,fx_delay_time:2,fx_delay_amt:40,fx_pan_freq:3,fx_pan_amt:60,lfo_osc1_freq:0,lfo_fx_freq:0,lfo_freq:0,lfo_amt:0,lfo_waveform:0,p:[2,2,2,2,2,2,2,2,2,2],c:[{n:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{n:[137,0,0,137,137,0,0,137,135,0,0,135,135,0,0,135,134,0,0,134,132,0,0,132,132,0,0,132,132,0,0,132]}]},{osc1_oct:8,osc1_det:0,osc1_detune:0,osc1_xenv:0,osc1_vol:80,osc1_waveform:3,osc2_oct:8,osc2_det:0,osc2_detune:8,osc2_xenv:0,osc2_vol:80,osc2_waveform:3,noise_fader:40,env_attack:1e3,env_sustain:3e3,env_release:8e3,env_master:150,fx_filter:1,fx_freq:9e3,fx_resonance:100,fx_delay_time:6,fx_delay_amt:60,fx_pan_freq:3,fx_pan_amt:80,lfo_osc1_freq:0,lfo_fx_freq:0,lfo_freq:3,lfo_amt:120,lfo_waveform:0,p:[0,0,2,2,0,0,2,2,2,2],c:[{n:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{n:[111,0,0,111,120,0,0,120,111,0,0,111,120,0,0,120,111,0,0,111,120,0,0,120,111,0,0,111,120,0,0,120]}]}],songLen:50};var is=(t=>(t.easy="easy",t.medium="medium",t.hard="hard",t))(is||{});const os=new class{constructor(){this.stages=Object.values(is),this.currentIndex=0}next(){return++this.currentIndex>=this.stages.length&&(this.currentIndex=0),this.stages[this.currentIndex]}get(){return this.stages[this.currentIndex]}};class rs extends Event{}class cs extends EventTarget{}class ls extends rs{constructor(t){super(ls.name),this.newAmount=t}}const hs=new class extends cs{constructor(){super(...arguments),this.amountOfPlayers=1,this.getAmountOfPlayers=()=>this.amountOfPlayers,this.setAmountOfPlayers=t=>{this.amountOfPlayers!==t&&(this.amountOfPlayers=t,this.dispatchEvent(new ls(t)))}}toggleAmountOfPlayers(){this.setAmountOfPlayers(1==this.amountOfPlayers?2:1)}};class us extends nt{}const ds=t=>{const e=ns(t,"Choppa");e.add(new us);const s=(B?"TAP":"PRESS [SPACE]")+" TO DEPLOY";let n=1;const a=t.createEntity().add(new us).add(new ss({font:"18pt Courier",textAlign:"center",textBaseline:"middle",fillStyle:"#fff"},[()=>n?s:"",()=>B?"":`DIFFICULTY: ${os.get()} - PRESS [K] TO CHANGE`,()=>B?I.isLandscape?(setTimeout((()=>hs.setAmountOfPlayers(2)),100),"Rotate screen for single player"):(setTimeout((()=>hs.setAmountOfPlayers(1)),100),"Rotate screen for two players"):"Press 'a' to toggle players"])),i=document.createElement("p");return i.innerHTML='Based on <a href="https://js13kgames.com/2024/games/squad-13">SQUAD 13</a> at <a href="https://js13kgames.com">js13k</a>',i.style.position="absolute",i.style.bottom="10px",i.style.left="10px",i.style.color="#fff",i.style.fontSize="12px",i.style.zIndex="1000",document.body.appendChild(i),t.createEntity().add(new us).add(new Dt([new V(2e3,Y),new V(300,Y)])).add(new Mt(((t,s)=>{var o,r,c;(G[32]||D.length>0)&&(e.remove(),a.remove(),s.remove(),i.remove(),(o=as,r=void 0,c=function(){var t;return function(){var e,s,n,a={label:0,sent(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=r(0),i.throw=r(1),i.return=r(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function r(r){return function(c){return function(r){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,r[0]&&(a=0)),a;)try{if(e=1,s&&(n=2&r[0]?s.return:r[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,r[1])).done)return n;switch(s=0,n&&(r=[2&r[0],n.value]),r[0]){case 0:case 1:n=r;break;case 4:return a.label++,{value:r[1],done:0};case 5:a.label++,s=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(!((n=(n=a.trys).length>0&&n[n.length-1])||6!==r[0]&&2!==r[0])){a=0;continue}if(3===r[0]&&(!n||r[1]>n[0]&&r[1]<n[3])){a.label=r[1];break}if(6===r[0]&&a.label<n[1]){a.label=n[1],n=r;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(r);break}n[2]&&a.ops.pop(),a.trys.pop();continue}t=new AudioContext,r=[2,Qt(o,t.sampleRate).then((function(e){var s=t.createBufferSource();s.buffer=e,s.loop=1;var n=t.createGain();return n.gain.value=.5,n.connect(t.destination),s.connect(n),new te(n,s)}))]}catch(Qs){r=[6,Qs],s=0}finally{e=n=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:1}}([r,c])}}}()},new(r||(r=Promise))((function(t,e){function s(t){try{a(c.next(t))}catch(Qs){e(Qs)}}function n(t){try{a(c.throw(t))}catch(Qs){e(Qs)}}function a(e){var a;e.done?t(e.value):(a=e.value,a instanceof r?a:new r((function(t){t(a)}))).then(s,n)}a((c=c.call(void 0)).next())}))).then((t=>t.start())));const{easings:l}=s.get(Dt);let h=1;for(const e of l)e.step(t),h&&(h=0,e.timer.isDone()&&e.timer.reset(),n=e.timer.getProgress()<.65);G[65]&&l[1].timer.isDone()&&hs.toggleAmountOfPlayers(),G[75]&&l[1].timer.isDone()&&(l[1].timer.reset(),os.next())})))},fs=E.create(150,-200),ms=(t,e,s)=>{qe(t);const i=E.create(0,0),o=E.create(1e3,0);$e(t,"#FF7B54","#2B3A67"),Ze(t,"#FFE17B"),Je(t,"#1B2845"),1==s?je(t,e,i):(je(t,e,i.add(E.create(-100,200))),je(t,e,i.add(E.create(100,200)))),We(t,o.clone()),Qe(t,400),Xe(t);const r="HOLD [UP] TO FLY",c="HOLD [LEFT/RIGHT] TO TILT",l="HOLD [DOWN] TO DESCEND FASTER";t.addSystem(((t,e)=>{const s=e.tryGet(us);if(s&&s.some(a))return;const i=e.tryGet(dt);if(!i||!i.some(a))return;const h=i.find(a);if(!h)return;const u=n(h.entity),d=u.get(At),f=u.get(xt),m=f.value.dist(o)<300,g=!m&&f.value.dist(fs)<200,y=!m&&!g,p=(e.tryGet(lt)||[]).filter(a).map((t=>t.entity.tryGet(ts))).filter((t=>!!t));y?d.landed&&!p.some((t=>t.text==r))&&es(e,E.create(0,-200),r):p.forEach((t=>{t.text==r&&n(t.entity).remove()})),g?p.some((t=>t.text==c))||es(e,E.create(500,-200),c):p.forEach((t=>{t.text==c&&n(t.entity).remove()})),m?p.some((t=>t.text==l))||es(e,E.create(1e3,-200),l):p.forEach((t=>{t.text==l&&n(t.entity).remove()}))}))},gs=(t,e,s)=>{qe(t),$e(t,"#7AA5D2","#FFE4E1"),Ze(t,"#FFF4BD"),Je(t,"#546A7B"),ce(t,E.create(1500,-200),E.create(2e3,400),1),ue(t,E.create(4e3,-500),E.create(1200,400),1),Ye(t,1800),1==s?je(t,e,E.create(0,200)):(je(t,e,E.create(-100,200)),je(t,e,E.create(100,200))),We(t,E.create(6e3,200)),Qe(t,400),Xe(t)},ys=(t,e)=>{qe(t),$e(t,"#8B0000","#2B0000"),Ze(t,"#FF3D00"),Je(t,"#4A1919"),ce(t,E.create(300,-100),E.create(3e3,400),1),Ye(t,1400),Ye(t,2200),Ye(t,2300),Ye(t,2900),Ye(t,3e3),je(t,e,E.create(0,200)),We(t,E.create(3500,200)),Qe(t,400),Xe(t)};class ps extends r{constructor(){super(ps.name),this.walking=0,this.climbing=0}}const vs=(t,e,s)=>t.createEntity().add(new we).add(new ps).add(new xt(e)).add(new bt([new Q(E.create(),s)],((t,e)=>{const s=t.tryGet(be);s?s.target=e:t.add(new be(e));const{group:n}=e.get(bt);5===n&&(ne(t.world,t.get(xt).value.clone(),80,["#f00"]),t.remove())}),2).move(e.clone(),0)).add(new Mt(((t,e)=>{const s=e.get(ps);s.walking=0;const n=e.world.tryGet(dt);if(n&&n.find(a))for(const a of n){const n=a.entity.get(xt),i=e.get(xt);if(i.value.distPow2(n.value)<4e4){const a=e.tryGet(be);if(!a)return;const o=e.get(bt),r=a.entity.get(bt);i.value.x+=S(-t/100,n.value.x-i.value.x,t/100),i.value.x=S(r.aabb.minX,i.value.x,r.aabb.maxX);const c=r.shapes.reduce(((t,e)=>{const s=e.yAt(i.value.x);return null==t?s:null==s?t:t<s?s:t}),null);null!==c&&(i.value.y=c-l(o.shapes).radius),s.walking=1}}}))).add(new pt(((t,e,s)=>{const n=s.get(ps),a=s.get(we),i=s.get(xt);e.translate(i.value.x,i.value.y),e.fillStyle="#0c0",e.scale(.8,.8),e.beginPath(),e.arc(0,-12,4,0,2*w),e.fill(),e.strokeStyle="#0c0",e.lineJoin="round",e.lineCap="round",e.lineWidth=3,e.beginPath(),n.climbing?e.moveTo(-8,-15):e.moveTo(3*y(a.value.age*w*2)-8,-14),e.lineTo(-5,-5),e.lineTo(5,-5),n.climbing?e.lineTo(8,-14):e.lineTo(8,4),e.stroke(),e.lineWidth=4,e.beginPath(),e.moveTo(-3,0),e.lineTo(-3,16+2*y(a.value.age*w*4)*n.walking),e.moveTo(3,0),e.lineTo(3,16-2*y(a.value.age*w*4)*n.walking),e.stroke(),e.fillRect(-5,-8,10,16)}))),xs=(t,e)=>{qe(t),$e(t,"#00B4FF","#87CEEB"),Ze(t,"#FFFAA0"),Je(t,"#78A1BB"),ce(t,E.create(300,-200),E.create(2e3,400),1),vs(t,E.create(600,0),20),vs(t,E.create(700,0),20),vs(t,E.create(800,0),20),vs(t,E.create(900,0),20),je(t,e,E.create(0,200)),We(t,E.create(2600,200)),Qe(t,400),Xe(t)};var ws=(t=>(t[t.NotDone=0]="NotDone",t[t.Success=1]="Success",t[t.Failure=2]="Failure",t))(ws||{});class bs{constructor(){this.views=[]}step(t){const e=this.views[this.views.length-1];return e.step(t),e.getDone()}push(t){const e=this.views[this.views.length-1];e&&e.deactivate(),this.views.push(t),t.activate()}pop(){const t=this.views.pop();t&&(t.deactivate(),t.drop());const e=this.views[this.views.length-1];return e&&e.activate(),t}}class _s{constructor(t,e){this.game=t,this.gameCanvasBuffer=e}activate(){const t=this.game.tryGet(ut);if(t)for(const e of t)e.remove()}deactivate(){n(l(this.game.tryGet(at))).entity.add(new ut)}drop(){this.game.reset()}getDone(){return this.game.tryGet(mt)?ws.Success:this.game.tryGet(rt)?ws.Failure:ws.NotDone}step(t){this.game.step(t)}}class Ss{constructor(t,e){this.game=t,this.gameCanvasBuffer=e,this.gameContextBuffer=this.gameCanvasBuffer.getContext("2d"),ds(this.game)}activate(){const t=this.game.tryGet(ut);if(t)for(const e of t)e.remove()}drop(){const t=this.game.tryGet(us);if(t)for(let e of t)e.entity.remove()}deactivate(){n(l(this.game.tryGet(at))).entity.add(new ut)}getDone(){return this.game.tryGet(mt)||this.game.tryGet(rt)?ws.Success:ws.NotDone}step(t){this.game.step(t)}}const Ps=(t,e)=>{const s=e.tryGet(bt);if(s){for(let t of s){if(t.isRemoved())continue;const e=t.entity;if(!e.has(ft)){const s=e.get(xt),n=e.tryGet(Bt);t.move(s.value,n?n.rotation:0)}}for(let t=0;t<s.length-1;t++){const e=s[t],a=n(e.entity);for(let i=t+1;i<s.length;i++){const t=s[i],o=n(t.entity);if(e.group!==t.group&&e.aabb.is_overlap(t.aabb))for(let s of e.globalShapes)for(let n of t.globalShapes){const i=st(s,n);if(i){const r=new wt(a,s,o,n,i);e.on(o,r),t.on(a,r)}}}}}},Ts=(t,e,s,n)=>{const a=e.get(xt),i=n.get(pt),o=s.bufferContext;s.setPos(a.value),s.bufferCanvas.width=I.width,s.bufferCanvas.height=I.height,o.save(),o.translate(I.halfWidth,I.halfHeight),o.scale(s.zoom,s.zoom),o.translate(-s.int_pos.x,-s.int_pos.y);for(const r of i)r.isRemoved()||(o.save(),r.render(s,o),o.restore());for(const r of t)o.save(),r(s,o,n),o.restore();o.restore()},Rs=(t,e,s)=>{const n=s.tryGet(ss);if(n)for(const a of n){if(a.isRemoved())return;e.translate(t.int_pos.x,t.int_pos.y+100),e.font=a.style.font,e.textAlign=a.style.textAlign,e.textBaseline=a.style.textBaseline,e.fillStyle=a.style.fillStyle;let s=0;for(const t of a.content)e.fillText(t(),0,30*s++);e.restore()}},Ms=(t,e)=>{const s=e.tryGet(Ke);if(s)for(const n of s)n.isRemoved()||n.onResize()};var ks=(t=>(t[t.BottomLeft=0]="BottomLeft",t[t.BottomRight=1]="BottomRight",t))(ks||{});const Es=(t,e,s)=>(s.x=0===t?e.x:I.width-e.x,s.y=I.height-e.y,s);class As extends r{constructor(t,e,s=0){super(As.name),this.pos=t,this.align=e,this.splitScreen=s,this.indicatorPos=E.create(),this.indicatorRadius=10,this.joystickPos=E.create(),this.joystickRadius=120,this.joystickRadiusPow2=1e4,this.shootButtonPos=E.create(),this.shootButtonRadius=50,this.shootButtonRadiusPow2=2500,Es(e,t,this.joystickPos),Es(e,t,this.shootButtonPos),Es(e,t,this.indicatorPos),this.shootButtonOffset=E.create(0===e?-this.joystickRadius-this.shootButtonRadius:this.joystickRadius+this.shootButtonRadius,this.joystickRadius-this.shootButtonRadius),this.shootButtonPos.addMut(this.shootButtonOffset)}}const Cs=(t,e,s)=>{t.beginPath(),t.arc(e.x,e.y,s,0,_),t.closePath(),t.fill(),t.stroke()},Bs=E.create(),zs=(t,e)=>{const s=e.tryGet(As);if(s)for(let n of s){const{indicatorPos:t,joystickPos:e,joystickRadius:s,joystickRadiusPow2:a,shootButtonPos:i,shootButtonRadiusPow2:o,entity:r}=n,c=r;t.copyFrom(e);const l=c.get(de);l.left=0,l.right=0,l.up=0,l.down=0,l.shoot=0;let h=0,u=0;for(let n of D){if(!u&&n.distPow2(i)<o*I.ratioX&&(u=1,l.shoot=1),!h&&n.distPow2(e)<=a*I.ratioX){h=1,t.copyFrom(n),Bs.copyFrom(t).subtractMut(e);const a=Bs.x/s,i=Bs.y/s;l.reset(),a<-.5?l.left=1:a>.5&&(l.right=1),i<.5?l.up=1:i>.5&&(l.down=1)}if(u&&h)break}}},Gs=(t,e)=>{const s=e.tryGet(As);if(!s)return;const n=e.get(Oe),{context:a}=n[0];for(const i of s){const{entity:t,indicatorRadius:e,joystickRadius:s,joystickPos:n,shootButtonPos:o,indicatorPos:r,shootButtonRadius:c}=i,l=t.get(de);a.fillStyle=`rgba(0,0,0,${l.shoot?1:.5})`,Cs(a,o,c),a.fillStyle="rgba(0,0,0,0.5)",Cs(a,n,s),Cs(a,r,e)}},Ds=(t,e)=>{const s=e.tryGet(dt);if(!s)return;const i=n(s.find(a)?.entity).get(de);i.left=!!(G[37]||G[65]||G[81]),i.right=!(!G[39]&&!G[68]),i.up=!!(G[38]||G[87]||G[90]),i.down=!(!G[40]&&!G[83]),i.shoot=!!G[32]},Os=(t,e)=>{const s=e.tryGet(dt);if(!s)return;let a=0;for(const i of s){if(i.isRemoved())continue;const t=n(i.entity).get(de);0==a?(t.left=!!G[37],t.right=!!G[39],t.up=!!G[38],t.down=!!G[40],t.shoot=!!G[32]):(t.left=!(!G[65]&&!G[81]),t.right=!!G[68],t.up=!(!G[87]&&!G[90]),t.down=!!G[83],t.shoot=!!G[70]),a++}},Fs=(t,e)=>{const s=e.tryGet(Mt);if(s)for(const a of s)a.isRemoved()||a.step(t);const n=e.tryGet(Dt);if(n)for(const a of n)a.isRemoved()||a.step(t)},Ls=(t,e)=>{const s=e.tryGet(se);if(s)for(const n of s){if(n.isRemoved())continue;const{entity:e}=n,s=e.get(xt);n.full.step(t),n.nextShake.step(t),s&&n.nextShake.isDone()&&(n.nextShake.reset(),s.value.x+=20*T(-n.power,n.power),s.value.y+=20*T(-n.power,n.power)),n.full.isDone()&&e.tryGet(se)?.remove()}},Is=(t,e)=>{const s=e.tryGet(we);if(s)for(const n of s)n.isRemoved()||n.value.step(t)},qs=(t,e)=>{const s=e.tryGet(fe);if(s)for(const i of s){if(i.isRemoved())continue;const s=i.entity,o=e.tryGet(i.targetTag);if(i.load.step(t),!o||!i.load.isDone()||!o.some(a)){i.lockedTarget=null,i.target.reset();continue}const{lockedTarget:r}=i;if(r){if(!r.isRemoved()&&i.shouldTarget(s,r)){i.target.step(t);continue}i.lockedTarget=null}let c=0;for(const t of o)if(!t.isRemoved()&&i.shouldTarget(s,n(t.entity))){i.lockedTarget=n(t.entity),c=1;break}c||(i.lockedTarget=null,i.target.reset())}},js=(t,e,s)=>{const n=s.tryGet(fe);if(n){for(const t of n){if(!t.lockedTarget||t.isRemoved())continue;const s=t.target.getProgress(),n=t.entity.get(xt),a=t.lockedTarget.get(xt);e.save(),e.strokeStyle=e.fillStyle=s>=1?"#f00":"#ff0",e.globalAlpha=U(0,.2,s),e.beginPath(),e.lineWidth=U(40,4,s),e.moveTo(n.value.x,n.value.y),e.lineTo(a.value.x,a.value.y),e.stroke(),e.translate(a.value.x,a.value.y),e.globalAlpha=s,e.shadowColor="#000",e.shadowOffsetY=2;const i=U(2,1,s);e.scale(i,i),e.rotate(t.target.age*w);const o=20;e.lineWidth=2,e.beginPath(),e.arc(0,0,o,0,_),e.stroke();for(let t=0;t<4;t++)e.rotate(w/2),e.fillRect(o-5,0,10,2);e.restore()}e.restore()}},Ws=(t,e)=>{const s=e.tryGet(me),a=e.tryGet(ps);if(s&&a)for(const i of s){const e=n(i.entity),s=e.get(xt);let o=0;for(const r of a){const a=n(r.entity);if(i.human&&i.human!==a)continue;const c=a.get(xt),l=s.value.distPow2(c.value),h=l<62500;if(!h)continue;o=1;const u=l<1e4,d=i.human?0:h?100:0;u&&!i.human&&l<i.length**2&&(i.human=a,r.climbing=1),i.human?(i.length=c.value.y-s.value.y,i.grabbingLadderRatio+=t/250):i.grabbingLadderRatio=0,i.length!==d&&(i.length+=S(-t/10,d-i.length,t/10)),i.human&&(c.value.x=s.value.x,c.value.y=s.value.y+i.length,l<400)&&(i.human=null,e.get(ge).rescuedPrisoners++,a.remove())}!i.human&&!o&&i.length>0&&(i.length+=S(-t/10,-i.length,t/10)),i.length=S(-i.maxLength,i.length,i.maxLength)}},Xs=(t,e,s)=>{const a=s.tryGet(me);if(a)for(const i of a){if(i.isRemoved())continue;const t=n(i.entity),{value:s}=t.get(xt);e.save(),e.translate(s.x,s.y),e.fillStyle="#000",e.fillRect(-5,0,2,i.length),e.fillRect(5,0,-2,i.length);for(let n=i.length;n>=0;n-=10)e.fillRect(-5,n,10,2);e.restore()}},Ys=E.create(0,3),Hs=E.create(.3,.3),Ns=(t,e)=>{const s=e.tryGet(Ct);if(s)for(const n of s){if(n.isRemoved())continue;const t=n.entity,e=t.tryGet(xe),s=t.tryGet(xt);e&&(n.value.addMut(e.value),n.value.magnitudePow2()>n.maxSpeed&&n.value.normalizeMut().multiplyMut(n.maxSpeed)),n.value.dotMut(Hs),s&&!t.has(ft)&&(s.value.addMut(n.value),s.value.addMut(Ys))}},Us=(t,e,s)=>{ie(t,s.clone());const n=De(t,s.subtract(E.create(0,50)),Et.Right);return Le(t,e,s).add(new be(n,0)),n},Vs=(t,e,s)=>{(t=>{Ie(t)})(t),$e(t,"#FF6B35","#FFC4B0"),Ze(t,"#FFD700"),Je(t,"#4A3B52");const n=E.create(100,400),a=E.create(17e3,600);1===s?Us(t,e,n):(Us(t,e,n.add(E.create(-500,0))),Us(t,e,n.add(E.create(500,0))));const i=E.create(0,-1500),o=[[E.create(2e3,1e3),E.create(4e3,1500),E.create(6e3,1e3),E.create(8e3,2e3),E.create(1e4,1e3),E.create(12e3,1500),E.create(14e3,1e3),E.create(16e3,1e3),E.create(18e3,1e3)],[E.create(2e3,400),E.create(4e3,1e3),E.create(6e3,500),E.create(8e3,1e3),E.create(1e4,500),E.create(12e3,900),E.create(14e3,700),E.create(16e3,600),E.create(18e3,1e3)]];o.forEach((t=>t.forEach((t=>t.addMut(i))))),ce(t,n.add(E.create(200,200)),E.create(2e3,-200),1);for(let r=0;r+1<o[0].length;r++){const e=o[0][r],s=o[0][r+1];ce(t,e,s.subtract(e).absMut(),1)}ue(t,n.add(E.create(-400,-300)),E.create(2e3,-500),1);for(let r=0;r+1<o[1].length;r++){const e=o[1][r],s=o[1][r+1];ue(t,e,s.subtract(e),1)}Ye(t,4500),Ye(t,8e3),Ye(t,12e3),vs(t,E.create(6e3,900),20),vs(t,E.create(1e4,900),20),vs(t,E.create(14e3,900),20),((t,e)=>{ie(t,e.add(E.create(0,450)),1)})(t,a),Qe(t,400),Xe(t)};class Js extends nt{}class Ks{constructor(t,e){this.game=t,this.gameCanvasBuffer=e,this.setupCompletion()}setupCompletion(){const t=ns(this.game,"MISSION\nCOMPLETE","#00E5FF","#000");t.add(new Js);let e=1;const s=(B?"TAP":"PRESS [SPACE]")+" TO RETURN TO MAIN MENU",n=this.game.createEntity().add(new Js).add(new ss({font:"18pt Courier",textAlign:"center",textBaseline:"middle",fillStyle:"#00E5FF"},[()=>e?s:""]));this.game.createEntity().add(new Js).add(new Dt([new V(2e3,Y)])).add(new Mt(((s,a)=>{(G[32]||D.length>0)&&(t.remove(),n.remove(),a.remove(),a.add(new mt));const{easings:i}=a.get(Dt),o=i[0];o.step(s),o.timer.isDone()&&o.timer.reset(),e=o.timer.getProgress()<.65})))}activate(){const t=this.game.tryGet(ut);if(t)for(const e of t)e.remove()}drop(){const t=this.game.tryGet(Js);if(t)for(let e of t)e.entity.remove()}deactivate(){n(l(this.game.tryGet(at))).entity.add(new ut)}getDone(){return this.game.tryGet(mt)?ws.Success:ws.NotDone}step(t){this.game.step(t)}}class $s{constructor(t){this.viewManager=new bs,this.levels=[ms,gs,xs,ys,Vs],this.currentLevel=0,this.currentDifficulty=0,this.amountOfPlayers=1,this._stop=()=>{},I.setCanvas(t),onresize=I.resize,I.resize(),hs.addEventListener(ls.name,(t=>{this.amountOfPlayers=t.newAmount,this.loadLevel(this.amountOfPlayers),this.viewManager.push(new _s(this.game,I.canvas)),this.viewManager.push(new Ss(this.game,I.canvas))})),this.loadLevel(this.amountOfPlayers),this.viewManager.push(new _s(this.game,I.canvas)),this.viewManager.push(new Ss(this.game,I.canvas))}loadLevel(t){if(this.game=(()=>{const t=new c,e=(s=t=>{const e=t.tryGet(dt);if(!e||!e.some(a))return 1;let s=0;for(const n of e)s+=n.entity.tryGet(At)?1:0;return s<2},(t,e)=>(n,a)=>(s(a)?t:e)(n,a));var s;const i=[Rs,Xs,js],o=e((t=>(e,s)=>{const a=s.get(Oe)[0],{context:i}=a,o=n(a.entity),r=o.get(ee);Ts(t,o,r,s),i.drawImage(r.bufferCanvas,0,0)})(i),(t=>(e,s)=>{const a=s.get(Oe);let i=0;for(const o of a)if(!o.isRemoved()){const e=n(o.entity),a=e.get(ee);Ts(t,e,a,s),o.context.drawImage(a.bufferCanvas,~~(I.halfWidth/2),0,~~I.halfWidth,~~I.height,~~(I.halfWidth*i),0,~~I.halfWidth,~~I.height),i++}})(i)),r=[B?zs:e(Ds,Os),Is,Ns,Fs,Ps,Ls,qs,Ws,o];return B&&r.push(Gs),r.push(Ms),r.forEach((e=>t.addSystem(e))),t})(I.context),this.levels[this.currentLevel](this.game,I.context,t),B){const t=this.game.tryGet(de);for(let e=0;e<t.length;e++)t[e].entity.add(new As(E.create(250,150),0==e?ks.BottomLeft:ks.BottomRight))}}step(t){const e=this.viewManager.step(t);if(e!=ws.NotDone)switch(this.viewManager.pop().constructor.name){case Ks.name:case Ss.name:break;case _s.name:e==ws.Success?(this.currentLevel++,this.currentLevel>=this.levels.length?(this.currentLevel=1,this.loadLevel(this.amountOfPlayers),this.viewManager.push(new _s(this.game,I.canvas)),this.viewManager.push(new Ss(this.game,I.canvas)),this.viewManager.push(new Ks(this.game,I.canvas))):(this.loadLevel(this.amountOfPlayers),this.viewManager.push(new _s(this.game,I.canvas)))):e==ws.Failure&&(this.loadLevel(this.amountOfPlayers),this.viewManager.push(new _s(this.game,I.canvas)))}}start(){this._stop=function(t,e=1e3/30,s=1){let n=0,a=1;const i=o=>{a&&(requestAnimationFrame(i),t.step(Math.min(o-n,e)*s),n=o)};return requestAnimationFrame(i),()=>{a=0}}(this)}stop(){this._stop()}}onload=async()=>{new $s(document.getElementById("g")).start()};
